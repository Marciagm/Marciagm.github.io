<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,user-scalable=0"/>
    <title>大树金融</title>
    <script src="js/jquery.js"></script>
    <script type="text/javascript">
        var window_width = 750;
        var window_size = 100;
        (function(){
            $.fn.autoSize = function(options){
                options = $.extend({}, $.fn.autoSize.defaults,options || {});
                autoSet();
                $(window).resize(function(){
                    autoSet();
                });
                function autoSet()
                {
                    var width = $(this).width();
                    var newsize = $.fn.autoSize.method.getFS(options.designWith,options.designFS,width);
                    $.fn.autoSize.method.setFS(options.target,newsize);
                }
            };
            $.fn.autoSize.method = {
                getFS : function(designWith,designFs,winWith){ //鑾峰彇fontsize
                    return winWith/designWith*100;
                },
                setFS : function(target,FS)
                {
                    target.style.fontSize = FS + "px";
                }
            };
            $.fn.autoSize.defaults = {
                designWith : 750,
                designFS   : 100,
                target : document.documentElement
            };
        })(jQuery);
        $(window).autoSize({
            designWidth : window_width,
            designFS : window_size
        });
    </script>

    <style type="text/css">
        @media screen and (min-width: 751px) {
            html{
                font-size: 100px !important;
            }
            body{
                width: 750px;
                margin: 0 auto !important;
            }
        }
        @font-face {
            font-family: chalkboard;
            src: url('./font/font.ttf');
        }

        @media screen and (min-height: 10.31rem){
          .video{
            height: 100%;
            object-fit: fill;
          }
        }
        html {
            height: 100%;
        }
        body {
            width: 7.5rem;
            height: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }
        * {
            padding: 0;
            margin: 0;
            cursor: pointer;
        }
        #wrapper {
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            position: absolute;
            overflow: hidden;
        }
        /*loading*/
        #loading {
            height: 13.35rem;
            box-sizing: border-box;
            background: url(images/christamas/loading.png);
            background-size: 100% 100%;
            text-align: center;
        }
        .loading-part {
            position: absolute; 
            left: 0.975rem; 
            top: 4.14rem; 
            width: 5.53rem; 
            height:3.61rem;
        }
        .loading-santa {
            width: 1.37rem;
            position: absolute;
            left: -1rem;
            top: 0;
        }
        .loading-bar {
            width: 5.53rem;
            top: 1.33rem;
            height: 0.22rem;
            position: absolute;
            left: 0;
            border: 0.02rem solid black;
            background-color: #4a4545;
            border-radius: 0.25rem;
        }
        .loading-run {
            position: absolute;
            left: 0.04rem;
            width: 0;
            height: 0.18rem;
            top: 1.37rem; 
            border: 0;
            border-radius: 0.25rem;
        /*    background: repeating-linear-gradient(-40deg,#F8B62D,#F8B62D,8px,#FE3A5F 0,#FE3A5F 16px); 
        */    background: repeating-linear-gradient(-42deg,#FE3A5F,#FE3A5F,10px,#F8B62D 0,#F8B62D 18px);   
        }

        #percent {
            font-size: 0.6rem;
            font-family: 'chalkboard';
            color: #FE3A5F;
            margin-top: 2rem;
        }

        /*page1*/
        #page1 {
            /*position: absolute;
            left: 0;
            top: 0;
            width: 7.5rem;
            height: 13.35rem;
            display: none;*/
        }
        .video {
            width: 7.5rem; 
            height: 100%; 
            position: absolute; 
            left: 0; 
            top: 0;
            display: none;
            object-fit: fill;
        }
        #post {
            position: absolute;
            left: 0;
            top: 0;
            width: 7.5rem;
            height: 100%;
            background: url(images/christamas/finish.png);
            background-size: 7.5rem;
            display: none;
            z-index: 40;
        }
        #face {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        #replay {
            background-color: red;
            opacity: 0.2;
            height: 14.1%;
            width: 3.3rem;
            position: absolute;
            bottom: 16.17%;
            left: 0.4rem;
        }
        #moveon {
            background-color: red;
            opacity: 0.2;
            height: 14.1%;
            width: 3.3rem;
            position: absolute;
            bottom: 16.17%;
            right: 0.4rem;   
        }
        /* page2 */
        #page2 {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: url(images/christamas/bg.png);
            display: none;
        }
        #page3 {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: url(images/christamas/bg.png);
            display: none;
        }
        .cloud {
            width: 86.97rem;
            position: absolute;
            top: 0;
            left: 0;
        }
        #tip {
            position: absolute;
            top: 2.8rem;
            left: 2.65rem;
            width: 2.2rem;
        }
        .barrier {
            position: absolute;
            left: 0;
            bottom: 0;
            z-index: 0;
            width: 102.76rem;
            height: 100%;
        }
        .santa {
            width: 2.07rem;
            position: absolute;
            left: 0.77rem;
            bottom: 2.67rem;
            z-index: 1;
        }
        .right-arrow {
            width: 0.37rem;
            top: 4.9rem;
            right: 2rem;
            position: absolute;
            transform:rotate(90deg);
            -ms-transform:rotate(90deg);     /* IE 9 */
            -moz-transform:rotate(90deg);    /* Firefox */
            -webkit-transform:rotate(90deg); /* Safari 和 Chrome */
            -o-transform:rotate(90deg);
            animation:moveright 2s infinite;
            -webkit-animation:moveright 2s infinite; 
        }
        .right-turn {
            width: 1.56rem;
            position: absolute;
            top: 4.9rem;
            right: 2.29rem;
        }
        #page6 {
            display: none;
            width: 7.5rem;
            background: url(images/christamas/lastbg.png);
            background-size: 100% 100%;
        }
        #bt {
            width: 7.5rem;
            position: absolute;
            top: -0.35rem;
            left: 0;
        }
        #bigpart {
            width: 7.5rem;
            position: absolute;
            top: 0;
            left: 0;
        }
        #qrcode {
            width: 7.5rem;
            position: absolute;
            top: 0;
            left: 0;   
        }
        #goshare {
            position: absolute; 
            height: 1rem; 
            width: 2.5rem; 
            bottom: 0.8rem; 
            right: 0.71rem;
            opacity: 0.4; 
            background-color: red;
        }

        /*all*/
        #next {
            display: none;
            position: absolute;
            bottom: 0;
            height: 100%;
            width: 7.5rem;
        }
        #gift {
            position: relative;
            left: 0;
            top: 0;
            width: 7.5rem;
            height: 100%;
            display: none;
            z-index: 10;
        }
        #gift1, #gift2 {
            position: absolute;
            left: 0;
            top: 0;
            width: 7.5rem;
            height: 100%;
            display: none;
            z-index: 10;
        }
        #gift2 {
            background-size: 7.5rem;
            background: url(images/christamas/open.png);
            background-size: 100% 100%;
        }
        #gift1 {
            background-size: 7.5rem;
            background: url(images/christamas/gift.png);
            background-size: 100% 100%;
        }
        .next {
            width: 0.37rem;
            position: absolute;
            bottom: 1.46rem;
            left: 3.565rem;
            display: block;
            animation:moveup 2s infinite;
            -webkit-animation:moveup 2s infinite; 
        }
        .turn {
            width: 1.98rem;
            position: absolute;
            bottom: 1.13rem;
            left: 2.76rem;
            display: block;
        }

        #share {
            display: none;
            width: 7.5rem;
            height: 100%;
            background-size: 100% 100%;
        }
        .cover {
            width: 75rem; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0
        }
        @keyframes moveright
        {
            from {right: 2rem;}
            to {right: 0.4rem;}
        }
        @-webkit-keyframes moveright 
        {
            from {right: 2rem;}
            to {right: 0.4rem;}
        }
        @keyframes moveup
        {
            from {bottom: 1.46rem;}
            to {bottom: 2.46rem;}
        }
        @-webkit-keyframes moveup 
        {
            from {bottom: 1.46rem;}
            to {bottom: 2.46rem;}
        }

    </style>
</head>
<body>
    <div id="wrapper">
        <!-- loading part-->
        <div id="loading">
            <div class="loading-part">
                <img class="loading-santa" src="images/christamas/santa.gif">
                <div class="loading-bar"></div>    
                <div class="loading-run"></div>
                <div id="percent">0</div>
            </div>
        </div>

        <div id="page1">
            <video id="videoA" width="7.5rem" class="video" poster="images/christamas/loading.png" preload="auto" src="materia/A.mp4" x-webkit-airplay="true" playsinline="true" webkit-playsinline="true">
            </video>
            <div id="post">
                <img id="face" src="images/christamas/head.gif">   
                <div id="replay"></div>
                <div id="moveon"></div> 
            </div>
        </div>

        <div id="page2">
            <img src="images/christamas/tip.png" id="tip" />
            <img src="images/christamas/cloud.png" class="cloud" id="cloud" />
            <img id="barrier" class="barrier" src="images/christamas/barrier.png"/>
            <img id="santa" class="santa" src="images/christamas/santa.gif">
            <div id="gift">
                <img src="images/christamas/arrow.png" class="right-arrow">
                <img src="images/christamas/right-turn.png" class="right-turn">
            </div>
        </div>

        <div id="page3">
            <video id="videoB" width="7.5rem" class="video" preload="auto" src="materia/B.mp4" x-webkit-airplay="true" playsinline="true" webkit-playsinline="true">
            </video>
        </div>

        <div id="page4">
            <div id="gift1">
                <img src="images/christamas/arrow.png" class="next">
                <img src="images/christamas/gift-turn.png" class="turn">
            </div>
            <video id="videoC" width="7.5rem" class="video" poster="images/christamas/gift.png" preload="auto" src="materia/C.mp4" x-webkit-airplay="true" playsinline="true" webkit-playsinline="true">
            </video>
            <audio id="three" src="materia/three.mp3" preload="auto"></audio>  
        </div>
        <div id="page5">
            <div id="gift2">
                <img src="images/christamas/arrow.png" class="next">
                <img src="images/christamas/open-turn.png" class="turn">
            </div>
            <video id="videoD" width="7.5rem" poster="images/christamas/open.png" class="video" preload="auto" src="materia/D.mp4" x-webkit-airplay="true" playsinline="true" webkit-playsinline="true">
            </video>
        </div>
        <div id="page6" style="height: 100%">
            <img id="bt" src="images/christamas/bt.gif">
            <img id="qrcode" src="images/christamas/qrcode.gif?123">
            <img id="bigpart" src="images/christamas/bigpart.png?123">
            <div id="goshare"></div>
        </div>
        <div id="share">
            <img src="images/christamas/mb.png" class="cover">
            <img src="images/christamas/share.png" style="width: 2.54rem; position: absolute; top: 0.05rem; right: 0.25rem; z-index: 2;">    
        </div>
        <div id="next">
            <img src="images/christamas/arrow.png" class="next">
            <img src="images/christamas/turn.png" class="turn">
        </div>
    </div>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script type="text/javascript" th:src="js/weshare.js"></script>
    <script>
        var santaBottom = 30, jump, offset, clickNum = 0, alreadyclick;
        var images = [
            'images/christamas/barrier.png',
            'images/christamas/santa.gif',
            'images/christamas/cloud.png',
            'images/christamas/head.gif',
            'images/christamas/loading.png',
            'images/christamas/finish.png',
            'images/christamas/qrcode.gif',
            'images/christamas/share.png',
            'images/christamas/turn.png'  
        ];
        var gameDics = [
            /* step1 */
            {
                scope: [0, 2.66],
                bottom: 20
            },
            {
                scope: [2.66, 4.14],
                jump: 1,
                bottom: 20
            },
            {
                scope: [4.14, 10.26],
                bottom: 20
            },
            // 203
            {
                scope: [10.26, 12.29],
                jump: 0.5,
                bottom: 17.3
            },

            /* step2 */
            // 1295
            {
                scope: [12.29, 25.24],
                bottom: 17.3
            },

            /* step3 */
            // 168
            {
                scope: [25.24, 26.92],
                jump: 1.25,
                bottom: 26.7
            },
            // 655
            {
                scope: [26.92, 33.47],
                jump: 1,
                bottom: 26.7
            },
            // 148
            {
                scope: [33.47, 34.95],
                jump: 1,
                bottom: 26.7
            },
            // end of 1116
            {
                scope: [34.95, 38.08],
                bottom: 26.7
            },
            // 230
            {
                scope: [38.08, 40.31],
                jump: 0.2,
                bottom: 17.5
            },
            // 1450
            {
                scope: [40.31, 54.81],
                jump: 0.2,
                bottom: 17.5
            },
            // triangle start
            {
                scope: [54.81, 57.56],
                jump: 13,
                bottom: 26.2
            },
            // triangle end
            {
                scope: [57.56, 60.31],
                jump: 0.1,
                bottom: 11
            },
            /* step6 */
            {
                scope: [60.31, 72.47],
                jump: 1.3,
                bottom: 11
            },
            {
                scope: [72.47, 74.32],
                jump: 1.3,
                bottom: 11
            },
            // pink 346
            {
                scope: [74.32, 77.78],
                bottom: 32.06
            },
            // 166
            {
                scope: [77.78, 79.44],
                jump: 1.2,
                bottom: 32.06
            },
            // 1371-
            {
                scope: [76.69, 88.03],
                jump: 1.3,
                bottom: 32.06
            },
            // 224
            {
                scope: [88.03, 90.27],
                jump: 0.1,
                bottom: 28.02
            },
            {
                scope: [90.27, 91.06],
                bottom: 28.02
            }
        ];

        var videos = {
            'videoA': {
                duration: 15.5,
                id: 'videoA',
                src: 'materia/A.mp4'
            },
            'videoB': {
                duration: 3.9, 
                id: 'videoB',
                src: 'materia/B.mp4'
            },
            'videoC': {
                duration: 2.2, 
                id: 'videoC',
                src: 'materia/C.mp4'
            },
            'videoD': {
                duration: 23.9, 
                id: 'videoD',
                src: 'materia/D.mp4'
            }
        }
        var timer, progress = 0;
        function videoPlay (videoId, nextPageId) {
            console.log('in videoPlay');
            var videoItem = document.getElementById(videoId);
            videoItem.play();
            /*var videoTimer = setInterval(function () {
                console.log(videoItem.currentTime);
                if (videoItem.currentTime >= videos[videoId].duration) {
                    videoItem.pause();
                    clearInterval(videoTimer);
                    nextPage(videoId, nextPageId);
                }
            }, 50)*/
            videoItem.addEventListener('ended', function () {
                //videoItem.pause();
                //alert('ended');
                //clearInterval(videoTimer);
                nextPage(videoId, nextPageId);
            })
        }
        function nextPage (videoId, nextPageId) {
            if (nextPageId == 'page2') {
                $('#' + videoId).css('z-index', -1);
                $('#' + videoId).hide();
                //$('#' + videoId).remove();
                $('#post').show();
                $('#replay').click(function () {
                    $('#post').hide();
                    $('#' + videoId).show();
                    $('#' + videoId).attr('src', 'materia/A.mp4');
                    videoPlay(videoId, nextPageId);
                })

                $('#moveon').click(function () {
                    $('#' + videoId).hide();
                    $('#' + videoId).attr('src', '');
                    $('#face').hide();
                    $('#post').hide();

                    $('#page2').show();

                    setTimeout(function () {
                        $('#cloud').animate({
                            left: '-79.47rem'
                        }, 20000)
                        $('#barrier').animate({
                            left: '-91.06rem'
                        }, {
                            duration: 15000,
                            easing: 'linear',
                            step: function (now, tween) {
                                // 2.84+2
                                offset = 4.84 - now;
                                //console.log('offset: ' + offset);
                                for (var i = 0; i < gameDics.length; i++) {
                                    var step = gameDics[i];
                                    if (offset < step.scope[1] && offset >= step.scope[0]) {
                                        santaBottom = step.bottom;
                                        jump = step.jump || 10;
                                        /*if (step.jump && !alreadyclick) {
                                            $('#santa').animate({
                                                bottom: 0
                                            }, 10)
                                            $('#barrier').stop();
                                            $('#cloud').stop();
                                            /*setTimeout(function () {
                                                nextPage('videoA', 'page2');
                                            }, 1000)
                                        }*/
                                        alreadyclick = 0;
                                    }
                                }
                            },
                            complete: function () {
                                $('#gift').show();
                                $('#gift').on('touchstart', function () {
                                    $('#page2').fadeOut(500);
                                    $('#page3').fadeIn(500);
                                    $('#gift').hide();
                                    $('#videoB').show();
                                    videoPlay('videoB', 'page4');
                                })
                            }
                        })
                        var outTimer = setTimeout(function () {
                            $('#tip').fadeOut(1000).fadeIn(1000).fadeOut(1000);
                        }, 1000)
                        $('#page2').click(function () {
                            alreadyclick = 1;
                            clickNum ++;
                            if (clickNum >= 2) {
                                $('#tip').fadeOut(1000);
                                clearTimeout(outTimer);
                            }
                            var sLeft = ($('#santa').css('left').replace('px','') - 0);
                            var bLeft = $('#barrier').css('left').replace('px','') * 0.77 / sLeft ;
                            console.log('santaBottom: ' + santaBottom);
                            console.log('offset: ' + offset);
                            $('#santa').animate({
                                bottom: (santaBottom + 12) + '%',
                            }).animate({ 
                                bottom: santaBottom + '%'
                            })
                            /*if (jump != 10) {
                                $('#santa').animate({
                                    bottom: (santaBottom + jump - 0) + '%',
                                }).animate({ 
                                    bottom: santaBottom + '%'
                                })      
                            }
                            else {
                                $('#santa').animate({
                                    bottom: (santaBottom + 10 - 0) + '%',
                                }).animate({ 
                                    bottom: santaBottom + '%'
                                })  
                            }*/
                            //var offset = 0 - bLeft + 1.08;
                            
                        })
                    }, 1000)
                     
                })

            }
            else if (nextPageId === 'page3') {
                $('#' + videoId).hide();
                /*$('#gift').show();
                $('#gift').on('click', function () {
                    $('#gift').hide();
                    videoPlay('videoC', 'page4');
                })
                $('#videoB').hide();*/
            }
            else if (nextPageId === 'page4') {
                $('#' + videoId).hide();
                $('#gift1').show();
                console.log('in page4')
                $('#gift1').on('touchstart', function () {
                    $('#gift1').hide();
                    $('#page3').hide();
                    $('#videoC').show();
                    videoPlay('videoC', 'page5');
                })
            }
            else if (nextPageId === 'page5') {
                //$('#page4').hide();
                $('#gift2').show();
                $('#gift2').on('touchstart', function () {
                    $('#gift2').hide();
                    $('#page4').hide();
                    $('#videoD').show();
                    document.getElementById('three').play();
                    videoPlay('videoD', 'page6');
                })
            }
            else if (nextPageId === 'page6') {
                setTimeout(function () {
                    $('#page5').fadeOut(1000);
                    $('#page6').fadeIn(1000);
                }, 500)
                $('#goshare').click(function () {
                    $('#share').show();
                    $('#share').click(function () {
                        $('#share').hide();
                    })
                })
            }
        }
        function beforePlayVideo (videoId, nextPageId) {
            var startY = 0;
            var moveY = 0; 
            var endY = 0;
            var videoItem = document.getElementById(videoId); 
            $('#' + videoId).show();
            $('#next').show();

            $('#next').on('touchstart', function (event) {
                $('#next').hide();
                videoPlay(videoId, nextPageId);
            })
        }
        /**
         * loading images and move
         */
        function move (percent) {
            $('.loading-run').animate({
                width: percent * 5.51 + 'rem'
            }, 200, 'linear')

            $('.loading-santa').animate({
                left: (percent * 5.51 - 1) + 'rem'
            }, 200, 'linear', function () {
                $('#percent').html(Math.floor(percent * 100));
                if (percent == 1.0) {
                    clearInterval(timer);
                    timer = null;
                    setTimeout(function () {
                        $('#loading').hide();
                        /*$('#page1').show();*/
                        beforePlayVideo('videoA', 'page2');
                    }, 200)
                }    
            }) 
        }

        /**
         * loading images
         * 
         */
        function loading (images, videos) {
            var imgLength = images.length;
            var videoLength = 1;
            
            var videoArray = [];
            // backup
            for (var videoId in videos) {
                videoArray.push(videos[videoId]);
            }
            var total = imgLength + videoArray.length;
            /*timer = setInterval(function () {
                for (var i = 0; i < images.length; i++) {
                    var imgItem = images.shift();
                    var img = new Image();
                    img.src = imgItem;
                    if (img.complete) {
                        progress ++;
                        move(progress / total);
                        if (progress === total) {
                            clearInterval(timer)
                        }
                    }
                    else {
                        img.onload = function () {
                            progress ++;
                            move(progress / total);
                            clearInterval(timer);
                        }
                    }
                }
                // video
                for (var j = 0; j < videoArray.length - 3; j++) {
                    var videoItem = videoArray.shift();
                        document.getElementById(videoItem.id).addEventListener('canplaythrough', function ()
                    {
                        progress ++;
                        console.log(progress);
                        console.log('add');
                        move(progress / total);
                        if (progress === total) {
                            clearInterval(timer);
                        }
                    })
                }
            }, 100)*/
            

            timer = setInterval(function () {
                for (var i = 0; i < images.length; i++) {
                    var imgItem = images.shift();
                    var img = new Image();
                    img.src = imgItem;
                }
                progress =progress + Math.floor(Math.random() * 5);
                var percent = (progress / 100).toFixed(2);
                
                if (percent >= 1) {
                    move(1);
                    clearInterval(timer);
                }
                else {
                    move(percent);
                }
            }, 100)     
        }

        function init () {
            $(document).on('touchmove', function(e) {
                e.preventDefault();
            });
            $(document).on('WeixinJSBridgeReady',function(){
                $('#videoA').load();
                $('#videoB').load();
                $('#videoC').load();
                $('#videoD').load();
            });
            // wechat init part
            var url = location.href.split('#')[0];
            try {
                $.ajax({
                    type : "GET",
                    url : "/share",
                    data : {
                        url : url
                    },
                    success : function(data) {
                        console.info(data);
                        var timestamp = data.timestamp;
                        var noncestr = data.noncestr;
                        var signature = data.signature;
                        var appId = data.appid;
                        wxShare(true, appId, timestamp, noncestr, signature);
                    }
                });    
            }
            catch (e) {

            }
            
            loading(images, videos);
        }

        $(document).ready(function () {
            init(); 
        })

    </script>
</body>
</html>